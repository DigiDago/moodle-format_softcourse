{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Various actions on sections like update image, delete image, ...\n *\n * @module     format_softcourse/actions\n * @copyright  2019 Pimenko <contact@pimenko.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'theme_boost/bootstrap/tooltip'], function($, ajax) {\n    /**\n     * Updating of an image of a section.\n     */\n    let updateImageSection = function() {\n        $('.section-file').on('change', function(event) {\n            let sectionid = event.target.dataset.sectionid;\n            let courseid = event.target.dataset.courseid;\n            if (courseid) {\n                let file = event.target.files[0]; // Get only 1st file.\n                let filedata = null;\n                // Check if img.\n                if (!file.type.match('image.*')) {\n                    return;\n                }\n                let that = this;\n                let reader = new FileReader();\n                reader.onload = (function(file) {\n                    return function(e) {\n                        filedata = e.target.result;\n                        $(that).parent().parent().css('background-image', 'url(' + filedata + ')');\n                        $(that).parent().parent().addClass('not-empty');\n                        let imagedata = filedata.split('base64,')[1];\n                        let filename = file.name;\n                        ajax.call([\n                            {\n                                methodname: 'format_softcourse_update_section_image',\n                                args: {\n                                    courseid: courseid,\n                                    sectionid: sectionid,\n                                    imagedata: imagedata,\n                                    filename: filename\n                                },\n                                fail: function(response) {\n                                    window.console.error(response);\n                                }\n                            }\n                        ], true, true);\n                    };\n                })(file);\n                // Read img.\n                reader.readAsDataURL(file);\n            }\n        });\n    };\n\n    let deleteImageSection = function() {\n        $('.section-delete-file').on('click', function(event) {\n            event.preventDefault();\n            event.stopPropagation();\n            let sectionid = event.target.dataset.sectionid;\n            let courseid = event.target.dataset.courseid;\n            $(this).parent().parent().css('background-image', 'none');\n            $(this).parent().parent().removeClass('not-empty');\n            ajax.call([\n                {\n                    methodname: 'format_softcourse_delete_section_image',\n                    args: {\n                        courseid: courseid,\n                        sectionid: sectionid\n                    },\n                    fail: function(response) {\n                        window.console.error(response);\n                    }\n                }\n            ], true, true);\n        });\n    };\n\n    let toggle = function() {\n        $('[data-toggle=\"tooltip\"]').tooltip();\n    };\n\n    let courseformat = function() {\n        M.course = M.course || {};\n\n        M.course.format = M.course.format || {};\n\n        /**\n         * Get sections config for this format\n         *\n         * The section structure is:\n         * <ul class=\"softcourse\">\n         *  <li class=\"section\">...</li>\n         *  <li class=\"section\">...</li>\n         *   ...\n         * </ul>\n         *\n         * @return {object} section list configuration\n         */\n        M.course.format.get_config = function() {\n            return {\n                container_node : 'ul',\n                container_class : 'softcourse',\n                section_node : 'li',\n                section_class : 'section'\n            };\n        };\n\n        /**\n         * Swap section\n         *\n         * @param {YUI} Y YUI3 instance\n         * @param {string} node1 node to swap to\n         * @param {string} node2 node to swap with\n         */\n        M.course.format.swap_sections = function(Y, node1, node2) {\n            let CSS = {\n                COURSECONTENT : 'course-content',\n                SECTIONADDMENUS : 'section_add_menus'\n            };\n\n            let sectionlist = Y.Node.all('.' + CSS.COURSECONTENT + ' ' + M.course.format.get_section_selector(Y));\n            // Swap menus.\n            sectionlist.item(node1).one('.' + CSS.SECTIONADDMENUS).swap(sectionlist.item(node2).one('.' + CSS.SECTIONADDMENUS));\n        };\n\n        /**\n         * Process sections after ajax response\n         *\n         * @param {YUI} Y YUI3 instance\n         * @param {array} sectionlist\n         * @param {array} response ajax response\n         * @param {string} sectionfrom first affected section\n         * @param {string} sectionto last affected section\n         */\n        M.course.format.process_sections = function(Y, sectionlist, response, sectionfrom, sectionto) {\n            let CSS = {\n                SECTIONNAME : 'sectionname'\n            },\n            SELECTORS = {\n                SECTIONLEFTSIDE : '.left .section-handle .icon'\n            };\n\n            if (response.action === 'move') {\n                // If moving up swap around 'sectionfrom' and 'sectionto' so the that loop operates.\n                if (sectionfrom > sectionto) {\n                    let temp = sectionto;\n                    sectionto = sectionfrom;\n                    sectionfrom = temp;\n                }\n\n                // Update titles and move icons in all affected sections.\n                let ele, str, stridx, newstr;\n\n                for (let i = sectionfrom; i <= sectionto; i++) {\n                    // Update section title.\n                    let content = Y.Node.create('<span>' + response.sectiontitles[i] + '</span>');\n                    sectionlist.item(i).all('.' + CSS.SECTIONNAME).setHTML(content);\n                    // Update move icon.\n                    ele = sectionlist.item(i).one(SELECTORS.SECTIONLEFTSIDE);\n                    str = ele.getAttribute('alt');\n                    stridx = str.lastIndexOf(' ');\n                    newstr = str.substr(0, stridx + 1) + i;\n                    ele.setAttribute('alt', newstr);\n                    ele.setAttribute('title', newstr); // For FireFox as 'alt' is not refreshed.\n                }\n            }\n        };\n    };\n\n    return {\n        init: function() {\n            courseformat();\n            updateImageSection();\n            deleteImageSection();\n            toggle();\n        }\n    };\n});\n"],"names":["define","$","ajax","init","M","course","format","get_config","container_node","container_class","section_node","section_class","swap_sections","Y","node1","node2","CSS","sectionlist","Node","all","get_section_selector","item","one","swap","process_sections","response","sectionfrom","sectionto","SELECTORS","action","temp","ele","str","stridx","newstr","i","content","create","sectiontitles","setHTML","getAttribute","lastIndexOf","substr","setAttribute","on","event","sectionid","target","dataset","courseid","file","files","filedata","type","match","that","this","reader","FileReader","onload","e","result","parent","css","addClass","imagedata","split","filename","name","call","methodname","args","fail","window","console","error","readAsDataURL","preventDefault","stopPropagation","removeClass","tooltip"],"mappings":";;;;;;;AAsBAA,mCAAO,CAAC,SAAU,YAAa,kCAAkC,SAASC,EAAGC,YAiKlE,CACHC,KAAM,WAxFNC,EAAEC,OAASD,EAAEC,QAAU,GAEvBD,EAAEC,OAAOC,OAASF,EAAEC,OAAOC,QAAU,GAcrCF,EAAEC,OAAOC,OAAOC,WAAa,iBAClB,CACHC,eAAiB,KACjBC,gBAAkB,aAClBC,aAAe,KACfC,cAAgB,YAWxBP,EAAEC,OAAOC,OAAOM,cAAgB,SAASC,EAAGC,MAAOC,WAC3CC,kBACgB,iBADhBA,oBAEkB,oBAGlBC,YAAcJ,EAAEK,KAAKC,IAAI,IAAMH,kBAAoB,IAAMZ,EAAEC,OAAOC,OAAOc,qBAAqBP,IAElGI,YAAYI,KAAKP,OAAOQ,IAAI,IAAMN,qBAAqBO,KAAKN,YAAYI,KAAKN,OAAOO,IAAI,IAAMN,uBAYlGZ,EAAEC,OAAOC,OAAOkB,iBAAmB,SAASX,EAAGI,YAAaQ,SAAUC,YAAaC,eAC3EX,gBACc,cAElBY,0BACsB,iCAGE,SAApBH,SAASI,OAAmB,IAExBH,YAAcC,UAAW,KACrBG,KAAOH,UACXA,UAAYD,YACZA,YAAcI,SAIdC,IAAKC,IAAKC,OAAQC,WAEjB,IAAIC,EAAIT,YAAaS,GAAKR,UAAWQ,IAAK,KAEvCC,QAAUvB,EAAEK,KAAKmB,OAAO,SAAWZ,SAASa,cAAcH,GAAK,WACnElB,YAAYI,KAAKc,GAAGhB,IAAI,IAAMH,iBAAiBuB,QAAQH,SAEvDL,IAAMd,YAAYI,KAAKc,GAAGb,IAAIM,2BAC9BI,IAAMD,IAAIS,aAAa,OACvBP,OAASD,IAAIS,YAAY,KACzBP,OAASF,IAAIU,OAAO,EAAGT,OAAS,GAAKE,EACrCJ,IAAIY,aAAa,MAAOT,QACxBH,IAAIY,aAAa,QAAST,WAtJtCjC,EAAE,iBAAiB2C,GAAG,UAAU,SAASC,WACjCC,UAAYD,MAAME,OAAOC,QAAQF,UACjCG,SAAWJ,MAAME,OAAOC,QAAQC,YAChCA,SAAU,KACNC,KAAOL,MAAME,OAAOI,MAAM,GAC1BC,SAAW,SAEVF,KAAKG,KAAKC,MAAM,sBAGjBC,KAAOC,KACPC,OAAS,IAAIC,WACjBD,OAAOE,OAAU,SAAST,aACf,SAASU,GACZR,SAAWQ,EAAEb,OAAOc,OACpB5D,EAAEsD,MAAMO,SAASA,SAASC,IAAI,mBAAoB,OAASX,SAAW,KACtEnD,EAAEsD,MAAMO,SAASA,SAASE,SAAS,iBAC/BC,UAAYb,SAASc,MAAM,WAAW,GACtCC,SAAWjB,KAAKkB,KACpBlE,KAAKmE,KAAK,CACN,CACIC,WAAY,yCACZC,KAAM,CACFtB,SAAUA,SACVH,UAAWA,UACXmB,UAAWA,UACXE,SAAUA,UAEdK,KAAM,SAAS/C,UACXgD,OAAOC,QAAQC,MAAMlD,cAG9B,GAAM,IApBA,CAsBdyB,MAEHO,OAAOmB,cAAc1B,UAM7BjD,EAAE,wBAAwB2C,GAAG,SAAS,SAASC,OAC3CA,MAAMgC,iBACNhC,MAAMiC,sBACFhC,UAAYD,MAAME,OAAOC,QAAQF,UACjCG,SAAWJ,MAAME,OAAOC,QAAQC,SACpChD,EAAEuD,MAAMM,SAASA,SAASC,IAAI,mBAAoB,QAClD9D,EAAEuD,MAAMM,SAASA,SAASiB,YAAY,aACtC7E,KAAKmE,KAAK,CACN,CACIC,WAAY,yCACZC,KAAM,CACFtB,SAAUA,SACVH,UAAWA,WAEf0B,KAAM,SAAS/C,UACXgD,OAAOC,QAAQC,MAAMlD,cAG9B,GAAM,MAKbxB,EAAE,2BAA2B+E"}